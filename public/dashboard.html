<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Dashboard | SmartTask</title>
  <style>
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-sm border p-6 fade-in">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8 pb-4 border-b">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">SmartTask Dashboard</h1>
        <p class="text-gray-600 mt-1">Manage your tasks efficiently</p>
      </div>
      <div class="flex items-center gap-4">
        <span id="userName" class="text-gray-700 font-medium"></span>
        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium">
          Logout
        </button>
      </div>
    </div>

    <!-- Add Task Form -->
    <form id="taskForm" class="flex gap-3 mb-8">
      <input 
        id="taskInput" 
        type="text" 
        placeholder="What needs to be done?" 
        class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        required
        maxlength="200"
      >
      <button 
        type="submit"
        id="addTaskBtn"
        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium min-w-[100px] flex items-center justify-center gap-2"
      >
        <span id="addBtnText">Add Task</span>
        <svg id="addSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </button>
    </form>

    <!-- Task List -->
    <div id="taskContainer">
      <div id="loadingIndicator" class="text-center py-8">
        <div class="flex justify-center mb-3">
          <svg class="w-6 h-6 animate-spin text-blue-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
        <p class="text-gray-600">Loading tasks...</p>
      </div>

      <div id="emptyState" class="hidden text-center py-12">
        <div class="text-gray-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks yet</h3>
        <p class="text-gray-600">Add your first task above to get started!</p>
      </div>

      <ul id="taskList" class="space-y-3 hidden"></ul>
    </div>
  </div>

  <script src="assets/main.js"></script>
  <script>
    // State management
    let isLoading = false;
    let tasks = [];

    // DOM Elements
    const taskForm = document.getElementById('taskForm');
    const taskInput = document.getElementById('taskInput');
    const taskList = document.getElementById('taskList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const emptyState = document.getElementById('emptyState');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const addBtnText = document.getElementById('addBtnText');
    const addSpinner = document.getElementById('addSpinner');

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      const name = localStorage.getItem("name");
      const token = getToken();
      
      if (!token) {
        location.href = "index.html";
        return;
      }
      
      document.getElementById("userName").textContent = name || 'User';
      document.getElementById("logoutBtn").onclick = logout;
      
      loadTasks();
      setupEventListeners();
    });

    function setupEventListeners() {
      taskForm.addEventListener('submit', handleAddTask);
    }

    async function handleAddTask(e) {
      e.preventDefault();
      if (isLoading) return;

      const text = taskInput.value.trim();
      if (!text) return;

      await addTask(text);
    }

    async function loadTasks() {
      if (isLoading) return;
      
      isLoading = true;
      showLoadingState();
      
      try {
        const taskData = await apiFetch("/getTasks");
        tasks = taskData || [];
        renderTasks();
      } catch (err) {
        console.error('Failed to load tasks:', err);
        showNotification('Failed to load tasks', 'error');
      } finally {
        isLoading = false;
        hideLoadingState();
      }
    }

    async function addTask(text) {
      if (isLoading) return;
      
      isLoading = true;
      setAddButtonLoading(true);
      taskInput.disabled = true;

      try {
        await apiFetch("/addTask", {
          method: "POST",
          body: JSON.stringify({ text })
        });
        
        taskInput.value = '';
        showNotification('Task added successfully!', 'success');
        await loadTasks();
      } catch (err) {
        console.error('Failed to add task:', err);
        showNotification('Failed to add task', 'error');
      } finally {
        isLoading = false;
        setAddButtonLoading(false);
        taskInput.disabled = false;
        taskInput.focus();
      }
    }

    async function deleteTask(id) {
      if (isLoading) return;
      
      if (!confirm('Are you sure you want to delete this task?')) {
        return;
      }

      isLoading = true;
      const deleteBtn = document.querySelector(`[data-del="${id}"]`);
      const originalText = deleteBtn?.textContent;
      
      if (deleteBtn) {
        deleteBtn.textContent = 'Deleting...';
        deleteBtn.disabled = true;
      }

      try {
        await apiFetch(`/deleteTask/${id}`, { method: "DELETE" });
        showNotification('Task deleted successfully!', 'success');
        await loadTasks();
      } catch (err) {
        console.error('Failed to delete task:', err);
        showNotification('Failed to delete task', 'error');
        
        // Revert button state on error
        if (deleteBtn) {
          deleteBtn.textContent = originalText;
          deleteBtn.disabled = false;
        }
      } finally {
        isLoading = false;
      }
    }

    async function toggleTask(id, done) {
      if (isLoading) return;
      
      isLoading = true;
      const checkbox = document.querySelector(`[data-id="${id}"]`);
      
      if (checkbox) {
        checkbox.disabled = true;
      }

      try {
        await apiFetch(`/updateTask/${id}`, {
          method: "PUT",
          body: JSON.stringify({ done })
        });
        
        const action = done ? 'completed' : 'marked incomplete';
        showNotification(`Task ${action}!`, 'success');
      } catch (err) {
        console.error('Failed to update task:', err);
        showNotification('Failed to update task', 'error');
        
        // Revert checkbox on error
        if (checkbox) {
          checkbox.checked = !done;
        }
      } finally {
        isLoading = false;
        if (checkbox) {
          checkbox.disabled = false;
        }
      }
    }

    function renderTasks() {
      if (tasks.length === 0) {
        taskList.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      taskList.classList.remove('hidden');
      
      taskList.innerHTML = tasks.map(task => `
        <li class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors fade-in" data-task="${task._id}">
          <div class="flex items-center gap-3 flex-1">
            <input 
              type="checkbox" 
              ${task.done ? "checked" : ""} 
              data-id="${task._id}" 
              class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
            >
            <span class="${task.done ? 'line-through text-gray-500' : 'text-gray-800'} flex-1">
              ${escapeHtml(task.text)}
            </span>
          </div>
          <button 
            data-del="${task._id}" 
            class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-colors font-medium text-sm"
            title="Delete task"
          >
            Delete
          </button>
        </li>
      `).join('');

      // Add event listeners
      taskList.querySelectorAll("[data-del]").forEach(btn => {
        btn.onclick = () => deleteTask(btn.dataset.del);
      });

      taskList.querySelectorAll("input[type='checkbox']").forEach(cb => {
        cb.onchange = () => toggleTask(cb.dataset.id, cb.checked);
      });
    }

    function showLoadingState() {
      loadingIndicator.classList.remove('hidden');
      taskList.classList.add('hidden');
      emptyState.classList.add('hidden');
    }

    function hideLoadingState() {
      loadingIndicator.classList.add('hidden');
    }

    function setAddButtonLoading(loading) {
      if (loading) {
        addBtnText.textContent = 'Adding...';
        addSpinner.classList.remove('hidden');
        addTaskBtn.disabled = true;
      } else {
        addBtnText.textContent = 'Add Task';
        addSpinner.classList.add('hidden');
        addTaskBtn.disabled = false;
      }
    }

    function showNotification(message, type = 'info') {
      // Remove existing notifications
      document.querySelectorAll('.notification').forEach(n => n.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification ${
        type === 'error' ? 'bg-red-600' : 
        type === 'success' ? 'bg-green-600' : 
        'bg-blue-600'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>